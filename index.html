mkdir -p /var/www/miniapp
cat > /var/www/miniapp/index.html <<'HTML'
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KraftVPN MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px}
    .box{max-width:520px;margin:0 auto}
    button{width:100%;padding:12px 14px;font-size:16px}
    pre{white-space:pre-wrap;word-break:break-word;background:#f6f7f8;padding:12px;border-radius:8px}
  </style>
</head>
<body>
<div class="box">
  <h2>KraftVPN</h2>
  <p id="status">Загрузка...</p>
  <button id="btn" disabled>Получить данные</button>
  <pre id="out"></pre>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  const API = "https://api.blogyoga.site";

  function show(obj){ document.getElementById('out').textContent = JSON.stringify(obj, null, 2); }

  async function loadMe(){
    try{
      const initData = tg?.initData || "";
      if(!initData){
        document.getElementById('status').textContent = "Ошибка: Telegram initData пустой. Открой страницу из Mini App внутри Telegram.";
        return;
      }

      document.getElementById('status').textContent = "Запрос к API...";
      const r = await fetch(API + "/api/me", {
        headers: {
          "X-Tg-Init-Data": initData
        }
      });

      const data = await r.json().catch(()=>({status:"error",message:"bad_json"}));
      show({http_status: r.status, response: data});

      if(r.status === 404 && data?.message === "user_not_found"){
        document.getElementById('status').textContent =
          "Пользователь не найден в БД. Открой бота и нажми /start один раз, затем снова открой Mini App.";
        return;
      }

      if(r.status !== 200){
        document.getElementById('status').textContent = "Ошибка API: HTTP " + r.status;
        return;
      }

      document.getElementById('status').textContent = "OK. Подписка/QR готовы.";
    }catch(e){
      document.getElementById('status').textContent = "Ошибка: " + (e?.message || e);
      show({error: String(e)});
    }
  }

  document.getElementById('btn').onclick = loadMe;

  if(tg){
    tg.ready();
    document.getElementById('status').textContent = "Telegram WebApp готов. Нажми кнопку.";
    document.getElementById('btn').disabled = false;
  } else {
    document.getElementById('status').textContent = "Открой это внутри Telegram Mini App.";
  }
</script>
</body>
</html>
HTML
