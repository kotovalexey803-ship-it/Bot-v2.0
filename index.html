<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KraftVPN Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .ok { color: #065f46; }
    .err { color: #991b1b; }
    small { color: #6b7280; }
  </style>
</head>
<body>
  <h2>Mini App диагностика</h2>
  <div class="card">
    <div><b>API:</b> <code id="apiBase"></code></div>
    <div><b>initData длина:</b> <code id="initLen">0</code></div>
    <div><b>user:</b> <code id="userStr">—</code></div>
    <small>Открой именно внутри Telegram. В обычном браузере initData будет пустым.</small>
  </div>

  <div class="row">
    <button id="btnMe">Вызвать /api/me</button>
    <button id="btnHealth">Вызвать /health</button>
  </div>

  <div class="card">
    <b>Ответ</b>
    <pre id="out">—</pre>
  </div>

  <script>
    const API_BASE = "https://api.blogyoga.site";
    document.getElementById("apiBase").textContent = API_BASE;

    function out(obj, ok=true) {
      const el = document.getElementById("out");
      el.className = ok ? "ok" : "err";
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    // Telegram WebApp
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    if (!tg) {
      out("Telegram.WebApp не найден. Открой страницу внутри Telegram Mini App.", false);
    } else {
      tg.ready();
      tg.expand();

      const initData = tg.initData || "";
      document.getElementById("initLen").textContent = String(initData.length);

      const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
      document.getElementById("userStr").textContent = u ? `${u.id} @${u.username || ""}` : "—";

      async function call(path, withInit=true) {
        const headers = {};
        if (withInit) headers["X-Tg-Init-Data"] = initData;
        const r = await fetch(API_BASE + path, { method: "GET", headers, credentials: "omit" });
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        return { http: r.status, data };
      }

      document.getElementById("btnHealth").onclick = async () => {
        try {
          const res = await call("/health", false);
          out(res, res.http >= 200 && res.http < 300);
        } catch (e) {
          out(String(e), false);
        }
      };

      document.getElementById("btnMe").onclick = async () => {
        try {
          const res = await call("/api/me", true);
          out(res, res.http >= 200 && res.http < 300);
        } catch (e) {
          out(String(e), false);
        }
      };
    }
  </script>
</body>
</html>
