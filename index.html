<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>KraftVPN Mini App</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { --pad: 16px; }
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { padding: var(--pad); max-width: 520px; margin: 0 auto; }
    .card { border-radius: 14px; padding: 14px; background: rgba(0,0,0,.06); margin: 12px 0; }
    .row { display:flex; justify-content:space-between; gap: 12px; padding: 6px 0; }
    .muted { opacity: .7; }
    .err { background: rgba(255,0,0,.10); border: 1px solid rgba(255,0,0,.20); }
    .ok { background: rgba(0,128,0,.10); border: 1px solid rgba(0,128,0,.20); }
    button {
      width: 100%; border: 0; border-radius: 12px; padding: 12px 14px;
      font-size: 16px; cursor: pointer;
    }
    .btn { background: #2f6feb; color: #fff; }
    .btn2 { background: rgba(0,0,0,.08); }
    pre { white-space: pre-wrap; word-break: break-word; margin: 0; font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h2 style="margin: 10px 0 0;">Подписка</h2>
    <div class="muted" style="margin-top: 6px;">KraftVPN Mini App</div>

    <div id="status" class="card muted">Инициализация…</div>

    <div class="card">
      <div class="row"><div class="muted">Пользователь</div><div id="user">—</div></div>
      <div class="row"><div class="muted">ID</div><div id="uid">—</div></div>
    </div>

    <div class="card">
      <div class="row"><div class="muted">Статус</div><div id="sub_status">—</div></div>
      <div class="row"><div class="muted">До</div><div id="sub_until">—</div></div>
      <div class="row"><div class="muted">Лимит устройств</div><div id="device_limit">—</div></div>
    </div>

    <button class="btn" id="reloadBtn">Обновить данные</button>
    <div style="height:10px"></div>
    <button class="btn2" id="closeBtn">Закрыть</button>

    <div class="card" style="margin-top: 14px;">
      <div class="muted" style="margin-bottom:6px;">Диагностика</div>
      <pre id="debug">—</pre>
    </div>
  </div>

<script>
  // ВАЖНО: твой API домен (у тебя уже есть HTTPS на api.blogyoga.site)
  const API_BASE = "https://api.blogyoga.site";

  const el = (id) => document.getElementById(id);

  function setStatus(text, type="muted") {
    const s = el("status");
    s.className = "card " + type;
    s.textContent = text;
  }

  function safeJsonStringify(obj) {
    try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
  }

  async function apiGet(path, initData) {
    const url = API_BASE + path;
    const res = await fetch(url, {
      method: "GET",
      headers: {
        // Самое важное — передать initData на бэкенд
        "X-Telegram-Init-Data": initData,
        "Accept": "application/json"
      }
    });

    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json() : await res.text();

    if (!res.ok) {
      const err = new Error("HTTP " + res.status);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  async function loadData() {
    const tg = window.Telegram?.WebApp;

    if (!tg) {
      setStatus("Telegram WebApp SDK не загрузился.", "err");
      el("debug").textContent = "Нет window.Telegram.WebApp";
      return;
    }

    tg.ready();
    tg.expand();

    const initData = tg.initData || "";
    const initDataUnsafe = tg.initDataUnsafe || {};

    // Требование Telegram Mini App: initData должно быть непустым внутри Telegram
    if (!initData) {
      setStatus("Откройте мини-приложение внутри Telegram (нужно initData).", "err");
      el("debug").textContent = "initData пустой. Обычно так бывает, если открыть ссылку в Safari/Chrome, а не внутри Telegram.";
      return;
    }

    // Покажем базовую инфу из Telegram
    const u = initDataUnsafe.user || {};
    el("user").textContent = (u.username ? "@" + u.username : (u.first_name || "—"));
    el("uid").textContent = u.id ? String(u.id) : "—";

    setStatus("Загружаю данные из API…", "muted");
    el("debug").textContent = "API_BASE=" + API_BASE + "\n\ninitDataUnsafe:\n" + safeJsonStringify(initDataUnsafe);

    try {
      // 1) /api/me — бэкенд должен провалидировать initData и вернуть данные пользователя
      const me = await apiGet("/api/me", initData);

      // 2) user_id возьмём из ответа или из Telegram
      const userId = me.user_id || me.id || (u.id ? String(u.id) : null);

      // Обновим UI
      if (me.username) el("user").textContent = "@" + me.username;
      if (userId) el("uid").textContent = String(userId);

      // 3) попробуем получить подписку, если эндпоинт есть
      //    (если у тебя /sub/{user_id} отдаёт подписку — это оно)
      let sub = null;
      if (userId) {
        try {
          sub = await apiGet("/sub/" + encodeURIComponent(userId), initData);
        } catch (e) {
          // не критично
          sub = null;
        }
      }

      // Заполняем подписку максимально “мягко” (на случай разных полей)
      const status = sub?.status ?? me?.status ?? "—";
      const until  = sub?.until  ?? me?.until  ?? sub?.paid_to ?? me?.paid_to ?? "—";
      const limit  = sub?.device_limit ?? me?.device_limit ?? sub?.limit ?? me?.limit ?? "—";

      el("sub_status").textContent = String(status);
      el("sub_until").textContent = String(until);
      el("device_limit").textContent = String(limit);

      setStatus("Данные загружены.", "ok");
      el("debug").textContent =
        "API_BASE=" + API_BASE +
        "\n\n/api/me:\n" + safeJsonStringify(me) +
        (sub ? ("\n\n/sub/{user_id}:\n" + safeJsonStringify(sub)) : "\n\n/sub/{user_id}: не использовано или вернуло ошибку");

    } catch (e) {
      // Частая проблема: 404 user_not_found
      const detail = (e?.data && (e.data.detail || e.data)) ? (e.data.detail || e.data) : "";
      if (e.status === 404 && String(detail).includes("user_not_found")) {
        setStatus("Пользователь не найден. Сначала нажмите /start в боте и откройте Mini App заново.", "err");
      } else {
        setStatus("Не удалось загрузить данные из API: " + (e.message || "ошибка"), "err");
      }
      el("debug").textContent =
        "Ошибка:\n" + safeJsonStringify({ message: e.message, status: e.status, data: e.data });
    }
  }

  el("reloadBtn").addEventListener("click", loadData);
  el("closeBtn").addEventListener("click", () => {
    const tg = window.Telegram?.WebApp;
    if (tg) tg.close();
    else window.close();
  });

  loadData();
</script>
</body>
</html>
