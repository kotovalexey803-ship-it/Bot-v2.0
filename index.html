<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KraftVPN Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 16px; }
    .err { color: #b00020; font-weight: 600; }
    .ok { color: #0a7f2e; font-weight: 600; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
  </style>
</head>
<body>
  <div id="app">
    <div id="status">Загрузка…</div>
    <pre id="debug" style="white-space:pre-wrap;background:#f6f7f8;padding:10px;border-radius:10px;"></pre>
    <button id="retry" style="display:none;margin-top:10px;">Повторить</button>
  </div>

  <script>
    const API_BASE = "https://api.blogyoga.site";

    const statusEl = document.getElementById("status");
    const debugEl  = document.getElementById("debug");
    const retryBtn = document.getElementById("retry");

    function setStatus(text, isError=false) {
      statusEl.textContent = text;
      statusEl.className = isError ? "err" : "ok";
    }

    async function loadMe() {
      retryBtn.style.display = "none";
      setStatus("Загрузка…", false);
      debugEl.textContent = "";

      // Telegram WebApp object
      const tg = window.Telegram?.WebApp;

      if (!tg) {
        setStatus("Ошибка: telegram-web-app.js не загрузился", true);
        return;
      }

      // На всякий случай разворачиваем MiniApp и сообщаем Telegram, что готовы
      try { tg.ready(); tg.expand(); } catch (e) {}

      const initData = tg.initData || ""; // строка initData (подпись + user + auth_date и т.д.)
      const unsafeUser = tg.initDataUnsafe?.user;

      // Если initData пустой — значит открыли НЕ внутри Telegram WebApp
      if (!initData) {
        setStatus("Откройте мини-приложение внутри Telegram (нет initData).", true);
        debugEl.textContent = "initData пустой. Проверь: Web App открыт через кнопку/меню бота, не через обычный браузер.";
        retryBtn.style.display = "inline-block";
        return;
      }

      // Запрос в API: передаём initData в заголовке (надёжный вариант)
      try {
        const r = await fetch(`${API_BASE}/api/me`, {
          method: "GET",
          headers: {
            "X-Telegram-InitData": initData
          },
          cache: "no-store"
        });

        const text = await r.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }

        debugEl.textContent =
          `HTTP ${r.status}\n` +
          `tg.user: ${unsafeUser ? (unsafeUser.id + " @" + (unsafeUser.username || "")) : "n/a"}\n` +
          `response: ${JSON.stringify(data, null, 2)}`;

        if (!r.ok) {
          setStatus(`Ошибка API: HTTP ${r.status}`, true);
          retryBtn.style.display = "inline-block";
          return;
        }

        setStatus("OK: данные загружены", false);
        // Тут уже рисуешь интерфейс из data
      } catch (e) {
        setStatus("Ошибка сети при запросе к API", true);
        debugEl.textContent = String(e);
        retryBtn.style.display = "inline-block";
      }
    }

    retryBtn.addEventListener("click", loadMe);
    loadMe();
  </script>
</body>
</html>
